<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bringvit</title>
  <style>
    /* Global Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      background: #f4f6f8;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 24px;
      color: #1E3A8A;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
    }

    /* Buttons */
    .btn {
      padding: 10px 16px;
      margin-right: 6px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .btn-primary {
      background: #1E40AF;
      color: #fff;
    }
    .btn-secondary {
      background: #2563EB;
      color: #fff;
    }
    .btn-accent {
      background: #F59E0B;
      color: #fff;
    }
    .btn-danger {
      background: #DC2626;
      color: #fff;
    }

    /* Inputs */
    input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 4px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #2563EB;
      outline: none;
      box-shadow: 0 0 4px rgba(37,99,235,0.3);
    }
    label {
      font-weight: 500;
      margin-top: 12px;
      display: block;
    }

    /* Modal */
    .modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal .box {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      min-width: 320px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      position: relative;
      animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.95);}
      to {opacity:1; transform: scale(1);}
    }

    /* List items */
    #list div {
      margin-bottom: 12px;
    }
    #list button {
      margin-top: 6px;
    }

    /* Input small fix */
    #auth-section input {
      width: calc(100% - 12px);
    }
  </style>
</head>
<body>
  <h1>Bringvit</h1>

  <div id="auth-section" class="card">
    <h3>Login / Verify</h3>
    <div id="logged-out">
      <input id="email" placeholder="your email" /><br>
      <button id="send-code" class="btn btn-primary">Send verification code</button>
      <div style="margin-top:8px">
        <input id="code" placeholder="6-digit code" style="width:150px;"/>
        <input id="block" placeholder="block" style="width:100px;"/>
        <input id="floor" placeholder="floor" style="width:100px;"/>
        <button id="verify" class="btn btn-secondary">Verify & login</button>
      </div>
    </div>
    <div id="logged-in" style="display:none">
      <div>Logged in as <b id="me-email"></b></div>
      <div>Block: <span id="me-block"></span> | Floor: <span id="me-floor"></span></div>
      <button id="logout" class="btn btn-danger">Logout</button>
    </div>
  </div>

  <div class="card">
    <button id="place-order-btn" class="btn btn-primary">Place Order</button>
    <button id="view-takeorders" class="btn btn-secondary">Deliver Orders (takeorder)</button>
    <button id="my-orders-btn" class="btn btn-primary">My Orders</button>
    <button id="my-deliveries-btn" class="btn btn-accent">My Deliveries</button>
  </div>

  <div id="list" class="card"></div>

  <!-- Place order modal -->
  <div id="place-modal" class="modal" style="display:none">
    <div class="box">
      <h3>Place Order</h3>
      <label>Room <input id="o-room"/></label>
      <label>Block <input id="o-block"/></label>
      <label>Floor <input id="o-floor"/></label>
      <label>Delivery fee <input id="o-fee"/></label>
      <label>Request <textarea id="o-note"></textarea></label>
      <div style="margin-top:8px">
        <button id="send-get" class="btn btn-primary">Send</button>
<!--         <button id="send-post" class="btn btn-secondary">Send (POST json - recommended)</button> -->
        <button id="close-modal" class="btn btn-danger">Close</button>
      </div>
    </div>
  </div>

<script>
const API = "https://bringvit.pythonanywhere.com";

function getToken() { return localStorage.getItem("token"); }
function setToken(t) { if (t) localStorage.setItem("token", t); else localStorage.removeItem("token"); }
function getStoredUser() { try { return JSON.parse(localStorage.getItem("user")||"null"); } catch(e){return null;} }
function setStoredUser(u){ localStorage.setItem("user", JSON.stringify(u)); }

function showLoggedInUI() {
  const u = getStoredUser();
  if (!u) { document.getElementById("logged-in").style.display="none"; document.getElementById("logged-out").style.display="block"; return; }
  document.getElementById("me-email").innerText = u.email;
  document.getElementById("me-block").innerText = u.block;
  document.getElementById("me-floor").innerText = u.floor;
  document.getElementById("logged-in").style.display="block";
  document.getElementById("logged-out").style.display="none";
}

document.getElementById("send-code").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  if (!email) return alert("enter email");
  const res = await fetch(API+"/send_verification", {method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({email})});
  const j = await res.json();
  if (!res.ok) return alert("Failed: "+(j.error||JSON.stringify(j)));
  alert("Code sent to email (check inbox).");
};

document.getElementById("verify").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const code = document.getElementById("code").value.trim();
  const block = document.getElementById("block").value.trim();
  const floor = document.getElementById("floor").value.trim();
  if (!email||!code||!block||!floor) return alert("fill all fields");
  const res = await fetch(API+"/verify_email", {method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({email, code, block, floor})});
  const j = await res.json();
  if (!res.ok) return alert("Verify failed: "+(j.error||JSON.stringify(j)));
  setToken(j.token);
  setStoredUser({email: j.email, block, floor});
  showLoggedInUI();
  alert("Logged in!");
};

document.getElementById("logout").onclick = () => {
  setToken(null); localStorage.removeItem("user"); showLoggedInUI();
};

document.getElementById("place-order-btn").onclick = () => {
  document.getElementById("place-modal").style.display = "flex";
  const u = getStoredUser();
  if (u) { document.getElementById("o-block").value = u.block; document.getElementById("o-floor").value = u.floor; }
};
document.getElementById("close-modal").onclick = () => document.getElementById("place-modal").style.display = "none";

async function showList(html){ document.getElementById("list").innerHTML = html; }

document.getElementById("send-get").onclick = async () => {
  const t = getToken(); if(!t) return alert("login first");
  const room = document.getElementById("o-room").value;
  const block = document.getElementById("o-block").value;
  const floor = document.getElementById("o-floor").value;
  const fee = document.getElementById("o-fee").value;
  const note = document.getElementById("o-note").value;
  const res = await fetch(API+"/makeorder", {method:"GET", headers: {"Authorization": t,"X-Room": room,"X-Block": block,"X-Floor": floor,"X-Fee": fee,"X-Note": note}});
  const j = await res.json();
  if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
  alert("Order created ID: "+j.order.orderid);
  document.getElementById("place-modal").style.display="none";
};

// document.getElementById("send-post").onclick = async () => {
//   const t = getToken(); if(!t) return alert("login first");
//   const payload = { room: document.getElementById("o-room").value, block: document.getElementById("o-block").value, floor: document.getElementById("o-floor").value, fee: document.getElementById("o-fee").value, note: document.getElementById("o-note").value };
//   const res = await fetch(API+"/makeorder", {method:"POST", headers: {"Content-Type":"application/json", "Authorization": t}, body: JSON.stringify(payload)});
//   const j = await res.json();
//   if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
//   alert("Order created ID: "+j.order.orderid);
//   document.getElementById("place-modal").style.display="none";
// };

document.getElementById("view-takeorders").onclick = async () => {
  const t = getToken(); if(!t) return alert("login first");
  const res = await fetch(API+"/takeorder", {method:"GET", headers:{"Authorization":t}});
  const j = await res.json();
  if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
  const rows = j.orders.map(o => {
    return `<div style="border-bottom:1px solid #eee;padding:8px">
      <b>ID ${o.orderid}</b> (${o.server_provided_id})<br>
      ${o.room}, block ${o.block}, floor ${o.floor} — fee ${o.fee || '-'}<br>
      ${o.note || ''}<br>
      <button onclick="accept('${o.orderid}')" class="btn btn-accent">Accept delivery</button>
    </div>`;
  }).join("");
  showList(`<h3>Open Orders</h3>${rows || '<i>no open orders</i>'}`);
};

window.accept = async (orderid) => {
  const t = getToken(); if(!t) return alert("login first");
  const res = await fetch(API+"/accept_delivery", {method:"POST", headers: {"Content-Type":"application/json","Authorization":t}, body: JSON.stringify({orderid})});
  const j = await res.json();
  if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
  alert("Accepted order "+orderid);
};

document.getElementById("my-orders-btn").onclick = async () => {
  const t = getToken(); if(!t) return alert("login first");
  const res = await fetch(API+"/myorders", {method:"GET", headers:{"Authorization":t}});
  const j = await res.json();
  if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));

  const rows = j.orders.map(o => {
    let buttons = `<button onclick="cancelOrder('${o.orderid}')" class="btn btn-danger">Cancel order</button>`;
    if(o.status === "ASSIGNED"){ buttons += ` <button onclick="markReceived('${o.orderid}')" class="btn btn-accent">Mark Received</button>`; }
    return `<div style="border-bottom:1px solid #eee;padding:8px">
      <b>ID ${o.orderid}</b> — status ${o.status}<br>
      ${o.room}, ${o.block}, ${o.floor}<br>
      ${o.note || ''}<br>
      ${buttons}
    </div>`;
  }).join("");

  showList(`<h3>My Orders</h3>${rows||'<i>none</i>'}`);
};

window.markReceived = async (orderid) => {
  const t = getToken(); if(!t) return alert("login first");
  const res = await fetch(API+"/mark_received", {method:"POST", headers: {"Content-Type":"application/json","Authorization":t}, body: JSON.stringify({orderid})});
  const j = await res.json();
  if(!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
  alert("Order marked as received!");
  document.getElementById("my-orders-btn").click();
};

document.getElementById("my-deliveries-btn").onclick = async () => {
  const t = getToken(); if(!t) return alert("login first");
  const res = await fetch(API+"/mydeliveries", {method:"GET", headers:{"Authorization":t}});
  const j = await res.json();
  if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
  const rows = j.orders.map(o => `<div style="border-bottom:1px solid #eee;padding:8px">
    <b>ID ${o.orderid}</b> — status ${o.status}<br>
    ${o.room}, ${o.block}, ${o.floor}<br>
    <button onclick="cancelDelivery('${o.orderid}')" class="btn btn-danger">Cancel delivery</button>
  </div>`).join("");
  showList(`<h3>My Deliveries</h3>${rows||'<i>none</i>'}`);
};

window.cancelDelivery = async (orderid) => {
  const t = getToken(); if(!t) return alert("login first");
  const res = await fetch(API+"/cancel_delivery", {method:"POST", headers: {"Content-Type":"application/json","Authorization":t}, body: JSON.stringify({orderid})});
  const j = await res.json();
  if (!res.ok) return alert("Error: "+(j.error||JSON.stringify(j)));
  alert("Canceled delivery assignment");
};

showLoggedInUI();
</script>
</body>
</html>
